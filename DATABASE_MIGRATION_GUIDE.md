# Руководство по миграции в архитектуру с базой данных

## Обзор изменений

Мы переходим от архитектуры с отдельными папками для каждого пользователя к стандартной архитектуре с единой базой данных PostgreSQL и связанными таблицами.

### Преимущества новой архитектуры:
- ✅ Стандартный подход к хранению данных
- ✅ Лучшая производительность и масштабируемость
- ✅ ACID транзакции и целостность данных
- ✅ Упрощенное резервное копирование
- ✅ Возможность сложных запросов и аналитики
- ✅ Централизованное управление данными

## Структура базы данных

### Основные таблицы:
1. **users** - главная таблица пользователей
2. **user_categories** - категории расходов/доходов
3. **expenses** - записи о расходах
4. **budget_plans** - планы бюджета
5. **reminders** - напоминания
6. **user_settings** - настройки пользователей

### Связи между таблицами:
- Все дочерние таблицы ссылаются на `users.id` через внешние ключи
- При удалении пользователя все его данные удаляются автоматически (CASCADE)
- Поддержка индексов для оптимизации запросов

## Пошаговая миграция

### Шаг 1: Подготовка базы данных

1. **Установите PostgreSQL** (если еще не установлен):
   ```bash
   # Для Ubuntu/Debian
   sudo apt update
   sudo apt install postgresql postgresql-contrib
   
   # Для Windows - скачайте с официального сайта
   # https://www.postgresql.org/download/windows/
   ```

2. **Создайте базу данных**:
   ```sql
   -- Подключитесь к PostgreSQL как суперпользователь
   sudo -u postgres psql
   
   -- Создайте базу данных
   CREATE DATABASE finbot_db;
   
   -- Создайте пользователя (опционально)
   CREATE USER finbot_user WITH PASSWORD 'your_password';
   GRANT ALL PRIVILEGES ON DATABASE finbot_db TO finbot_user;
   ```

3. **Создайте схему таблиц**:
   ```bash
   psql -d finbot_db -f database_schema.sql
   ```

### Шаг 2: Настройка переменных окружения

Создайте файл `.env` в корне проекта:
```env
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=finbot_db
DATABASE_USER=finbot_user
DATABASE_PASSWORD=your_password
```

### Шаг 3: Установка зависимостей

Убедитесь, что в `requirements.txt` есть:
```
psycopg2-binary
```

Установите зависимости:
```bash
pip install -r requirements.txt
```

### Шаг 4: Выполнение миграции

1. **Создайте резервную копию** текущих данных (скрипт сделает это автоматически)

2. **Запустите скрипт миграции**:
   ```bash
   python migrate_to_database.py
   ```

3. **Проверьте результаты** миграции в логах

### Шаг 5: Обновление кода бота

После успешной миграции нужно обновить `bot.py` для работы с новой БД:

1. Импортируйте модуль базы данных:
   ```python
   from database import *
   ```

2. Замените функции работы с файлами на функции БД:
   - `get_user_folder_path()` → `get_user_by_telegram_id()`
   - Работа с JSON файлами → функции из `database.py`
   - И так далее...

## Проверка миграции

### Проверочные запросы:

```sql
-- Количество пользователей
SELECT COUNT(*) FROM users;

-- Количество расходов
SELECT COUNT(*) FROM expenses;

-- Расходы по категориям
SELECT 
    uc.category_name,
    COUNT(e.id) as expense_count,
    SUM(e.amount) as total_amount
FROM expenses e
JOIN user_categories uc ON e.category_id = uc.id
GROUP BY uc.category_name
ORDER BY total_amount DESC;
```

### Тестирование функций:

```python
# Тест создания пользователя
user = create_user(123456789, "test_user", "TestFolder")
print(f"Пользователь создан: {user}")

# Тест добавления расхода
expense = add_expense(user['id'], category_id, 100.50, "Тест расход")
print(f"Расход добавлен: {expense}")

# Тест получения расходов
expenses = get_user_expenses(user['id'])
print(f"Найдено расходов: {len(expenses)}")
```

## Откат изменений

Если что-то пошло не так:

1. **Остановите бота**
2. **Восстановите из резервной копии**:
   ```bash
   rm -rf users
   mv users_backup_YYYYMMDD_HHMMSS users
   ```
3. **Откатите изменения в коде**
4. **Перезапустите бота**

## Производительность

### Оптимизация запросов:
- Используйте индексы для часто запрашиваемых полей
- Применяйте LIMIT для больших выборок
- Кэшируйте часто используемые данные

### Мониторинг:
- Следите за размером базы данных
- Проверяйте медленные запросы
- Регулярно делайте резервные копии

## Безопасность

### Рекомендации:
- Используйте отдельного пользователя БД с ограниченными правами
- Регулярно обновляйте PostgreSQL
- Настройте SSL для подключения к БД
- Делайте регулярные резервные копии

### Резервное копирование:
```bash
# Создание дампа
pg_dump finbot_db > backup_$(date +%Y%m%d_%H%M%S).sql

# Восстановление из дампа
psql finbot_db < backup_YYYYMMDD_HHMMSS.sql
```

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь в правильности настроек БД
3. Проверьте права доступа пользователя БД
4. При необходимости восстановите из резервной копии

---

**Важно**: Всегда делайте резервную копию данных перед выполнением миграции!
